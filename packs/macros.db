{"name":"Refill Material Troves","type":"script","scope":"global","author":"1nIvj2kghHEjRn0P","img":"icons/skills/trades/mining-pickaxe-stone-cart.webp","command":"if (!token) {\n    ui.notifications.warn(\"Please select a token!\");\n    return;\n}\n\nconst troves = game.pf2eHeroicCrafting.getTroves(token.actor);\n\nconst troveHTML = troves.map(trove => {\n    const cost = game.pf2e.Coins.fromPrice(trove.system.price, trove.system.quantity);\n\n    return `\n        <div class=\"form-group trove-div\" data-item-id=\"${trove.id}\">\n            <span>${trove.name}</span>\n            <select autofocus class=\"troveLevel\">${[...Array(token.actor.level).keys()].map(level => {\n                level++;\n                const selected = trove.level === level ? `selected=\"selected\"` : ``;\n                return '<option value=\"'.concat(level, '\" ', selected, '>', level, '</option>');\n            })}</select>\n            <input type=\"text\" value=\"${cost}\" class=\"materials\" style='margin-right: 20px; margin-left: 20px'>\n            <strong class=\"bulk\" data-item-quantity=\"${trove.quantity}\">${trove.bulk}</strong>\n            <strong class=\"leftovers\">${trove.flags[\"pf2e-heroic-crafting-automation\"]?.leftovers || \"0 gp\"}</strong>\n        </div>\n    `\n});\n\nfunction updateRow(troveDiv) {\n    const materials = game.pf2e.Coins.fromString(troveDiv.children(\".materials\")[0].value);\n    const newTroveValue = game.pf2eHeroicCrafting.changeTroveValue(troveDiv.children(\".troveLevel\")[0].value, materials);\n\n    const formattedBulk = {\n        normal: Math.floor(newTroveValue.quantity / 10),\n        light: newTroveValue.quantity - (Math.floor(newTroveValue.quantity / 10) * 10)\n    };\n    let bulkHTML = \"\";\n\n    if (formattedBulk.normal > 0) {\n        bulkHTML += `${formattedBulk.normal}`;\n    }\n    if (formattedBulk.light > 0) {\n        bulkHTML += formattedBulk.normal > 0 ? `; ${formattedBulk.light}L` : `${formattedBulk.light}L`;\n    }\n    if (formattedBulk.normal === 0 && formattedBulk.light === 0) {\n        bulkHTML = \"-\";\n    }\n\n    troveDiv.children(\".bulk\").html(bulkHTML);\n    troveDiv.children(\".bulk\").attr(\"data-item-quantity\", newTroveValue.quantity);\n    troveDiv.children(\".leftovers\").html(newTroveValue.leftovers.toString());\n}\n\nconst dialogResults = await Dialog.wait({\n    title: \"Refill Material Troves\",\n    content: `\n            <form>\n                <body>\n                    <section>\n                        <h1>Refill Material Troves</h1>\n                    </section>\n                    <section>\n                        <p>Adjust the values of your Material Troves to fill them up. Their Bulk should change as you do so.</p>\n                        <p>You can adjust the level of your Material Troves up to your level. Higher level Material Troves contain more value in the same Bulk.</p> \n                        <p><strong>You must manually adjust any changes in your coins.</strong></p>\n                    </section>\n                </body>\n                <hr/>\n                <div class=\"form-group\">\n                    <strong>Name</strong>\n                    <strong>Level</strong>\n                    <strong style='margin-right: 20px; margin-left: 20px'>Value</strong>\n                    <strong>Bulk</strong>\n                    <strong>Leftover</strong>\n                </div>\n                <hr/>\n                ${troveHTML.join(\"\")}\n                <hr/>\n                <body>\n                    <section>\n                        <p><strong>Note:</strong> The Leftover column indicates value that cannot be represented with Bulk changes, but is still part of the Material Trove. As an example, if you Forage Crafting Resources for 1 day in a level 0 location, you would add 1 sp to your Material Trove -- but no Material Trove can actually represent that with a change in Bulk. This will still be accounted for, but will not show on the item.</p>\n                    </section>\n                </body>\n                <br/>\n            </form>\n        `,\n    buttons: {\n        refill: {\n            label: \"Refill\",\n            icon: \"<i class='fa-solid fa-toolbox'></i>\",\n            callback: (html) => {\n                let updates = [];\n\n                $(html).find(\".trove-div\").each(function () {\n                    const level = Number($(this).find(\".troveLevel\")[0].value) || 0;\n\n                    updates.push({\n                        _id: $(this).attr(\"data-item-id\"),\n                        \"system.level.value\": level,\n                        \"system.price.value\": game.pf2eHeroicCrafting.spendingLimit(\"hour\", level),\n                        \"system.quantity\": Number($(this).find(\".bulk\").attr(\"data-item-quantity\")) || 0,\n                        \"flags.pf2e-heroic-crafting-automation.leftovers\": $(this).find(\".leftovers\").html()\n                    });\n                });\n\n                return updates;\n            }\n        },\n        cancel: {\n            label: \"Cancel\",\n            icon: \"<i class='fa-solid fa-ban'></i>\",\n        }\n    },\n    default: \"cancel\",\n    render: ([content]) => {\n        const materialInputs = content\n            .querySelectorAll(\".trove-div\");\n\n        for (let i = 0; i < materialInputs.length; i++) {\n            materialInputs[i].querySelector(\".troveLevel\").addEventListener(\"change\", (event) => {\n                updateRow($(event.target).parent());\n            });\n\n            materialInputs[i].querySelector(\".materials\").addEventListener(\"keyup\", (event) => {\n                updateRow($(event.target).parent());\n            });\n        };\n    }\n}, { width: 600 });\n\nif (dialogResults !== \"cancel\") {\n    await token.actor.updateEmbeddedDocuments(\"Item\", dialogResults);\n}","ownership":{"default":0,"1nIvj2kghHEjRn0P":3},"flags":{"core":{"sourceId":"Macro.jrY2hhy4bMonPOZi"}},"_stats":{"systemId":"pf2e","systemVersion":"4.7.4","coreVersion":"10.291","createdTime":1676742042346,"modifiedTime":1676834371801,"lastModifiedBy":"1nIvj2kghHEjRn0P"},"folder":null,"sort":0,"_id":"HMpC7FAjshFyGOlQ"}
{"name":"Forage Crafting Resources","type":"script","scope":"global","author":"1nIvj2kghHEjRn0P","img":"icons/commodities/flowers/flower-green.webp","command":"// Editable values (or at least, ones I suggest):\n\nconst skillKey = \"sur\";\nconst rawTraits = [\"downtime\"];\n\n// End of editable values\n\nif (!token) {\n    ui.notifications.warn(\"Please select a token!\");\n    return;\n}\n\nconst actor = token.actor;\n\nconst dialogForm = `<form>\n    <body>\n        <section>\n            <h1>Forage Crafting Materials</h1>\n        </section>\n    </body>\n    <div class=\"form-group\">\n        <label for=\"taskLevel\">Task Level:</label>\n        <input type=\"number\" name=\"taskLevel\" id=\"taskLevel\" value=0 min=0 max=20>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"DC\">DC:</label>\n        <input type=\"number\" name=\"DC\" id=\"DC\" value=0 min=0>\n    </div>\n</form>`;\n\nconst dialogResults = await Dialog.wait({\n    title: \"Forage Crafting Resources\",\n    content: dialogForm,\n    buttons: {\n        ok: {\n            label: \"Forage\",\n            icon: \"<i class='fa-solid fa-wheat-awn'></i>\",\n            callback: (html) => {\n                return {\n                    DC: $(html).find(\"#DC\")[0].value || 0,\n                    level: $(html).find(\"#taskLevel\")[0].value || 0\n                };\n            }\n        },\n        cancel: {\n            label: \"Cancel\",\n            icon: \"<i class='fa-solid fa-ban'></i>\",\n        }\n    },\n    default: \"ok\",\n}, { width: 350 });\n\nif (dialogResults === \"cancel\") return;\n\nconst actionName = \"Forage Crafting Resources\";\nconst skillName = game.i18n.localize(CONFIG.PF2E.skills[skillKey]);\nconst skill = actor.system.skills[skillKey];\nconst proficiency = [\"proficiency:untrained\", \"proficiency:trained\", \"proficiency:expert\", \"proficiency:master\", \"proficiency:legendary\"]; // Reimplementing system functionality be like: \nconst modifiers = [];\nconst traits = [];\nconst notes = [...skill.notes];\nconst domains = ['all', 'skill-check', skillName.toLowerCase(), `${skill.ability}-based`, `${skill.ability}-skill-check`];\nconst options = actor.getRollOptions(domains);\noptions.push(`action:forage`, `skill:rank:${skill.rank}`, proficiency[skill.rank]);\n\nconst baseGatheredIncome = game.pf2e.Coins.fromString(game.pf2eHeroicCrafting.HeroicCraftingGatheredIncome[dialogResults.level]);\nlet gatheredIncome = baseGatheredIncome;\n\n{\n    // Default Notes\n\n    notes.push({\n        \"outcome\": [\"success\", \"criticalSuccess\"],\n        \"text\": \"<p><strong>Success</strong> Add the amount listed on Table 2: Gathered Income for the location's level to your Material Trove each day. If you are a master in Survival, instead add twice as much.</p>\"\n    });\n    notes.push({\n        \"outcome\": [\"failure\", \"criticalFailure\"],\n        \"text\": \"<p><strong>Failure</strong> You find no materials.</p>\"\n    });\n}\n{\n    // Converting raw traits into actual traits\n\n    const actionTraits = CONFIG.PF2E.actionTraits;\n    const traitDescriptions = CONFIG.PF2E.traitsDescriptions;\n\n    rawTraits\n        .map((trait) => ({\n            description: traitDescriptions[trait],\n            name: trait,\n            label: actionTraits[trait] ?? trait,\n        }))\n        .forEach(traitObject => traits.push(traitObject));\n}\n{\n    // If master in survival, double the crafting resources got\n\n    if (skill.rank >= 3) {\n        gatheredIncome = gatheredIncome.add(baseGatheredIncome);\n    }\n}\n{\n    // Vigilant Forager\n    if (options.includes(\"feat:vigilant-forager\")) {\n        modifiers.push(\n            new game.pf2e.Modifier({\n                slug: \"vigilant-forager-penalty\",\n                label: \"Vigilant Forager (after 8 hours or less)\",\n                modifier: -5,\n                predicate: [\"8-hours-or-less-of-exploration\"],\n            })\n        );\n    }\n}\n\ngame.pf2e.Check.roll(\n    new game.pf2e.CheckModifier(\n        `${actionName}`,\n        skill, modifiers),\n    {\n        actor: actor,\n        type: 'skill-check',\n        options,\n        domains,\n        createMessage: false,\n        notes,\n        dc: dialogResults.DC === 0 ? null : {\n            value: dialogResults.DC\n        },\n        traits\n    },\n    event,\n    async (roll, outcome, message) => {\n        if (message instanceof ChatMessage) {\n            let extraFlavour = ``;\n\n            // Practiced Forager\n            if (outcome === \"criticalSuccess\" && options.includes(\"feat:practiced-forager\")) {\n                gatheredIncome = gatheredIncome.add(baseGatheredIncome);\n            }\n\n            // General Summary\n            if (outcome === \"success\" || outcome === \"criticalSuccess\") {\n                extraFlavour = extraFlavour.concat(`<hr> <p><strong>Foundry Note</strong> You find <strong>${gatheredIncome.toString()}</strong> worth of materials. You can use the @UUID[Compendium.pf2e-heroic-crafting-automation.heroic-crafting-macros.HMpC7FAjshFyGOlQ]{Refill Material Troves} macro to add this value to your Material Troves.</p>`);\n            }\n\n            message.updateSource({ flavor: message.flavor + extraFlavour });\n            ChatMessage.create(message.toObject());\n        }\n    }\n);","ownership":{"default":0,"1nIvj2kghHEjRn0P":3},"flags":{"core":{"sourceId":"Macro.nL7aSJdVjJPxUfLm"}},"_stats":{"systemId":"pf2e","systemVersion":"4.8.3","coreVersion":"10.291","createdTime":1677934157512,"modifiedTime":1677944578996,"lastModifiedBy":"1nIvj2kghHEjRn0P"},"folder":null,"sort":0,"_id":"ZkMzPrKOjncgA7ER"}
